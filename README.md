[![Scrutinizer Code Quality](https://scrutinizer-ci.com/g/joskolenberg/laravel-jory/badges/quality-score.png?b=master)](https://scrutinizer-ci.com/g/joskolenberg/laravel-jory/?branch=master)
[![Code Coverage](https://scrutinizer-ci.com/g/joskolenberg/laravel-jory/badges/coverage.png?b=master)](https://scrutinizer-ci.com/g/joskolenberg/laravel-jory/?branch=master)
[![Build Status](https://scrutinizer-ci.com/g/joskolenberg/laravel-jory/badges/build.png?b=master)](https://scrutinizer-ci.com/g/joskolenberg/laravel-jory/build-status/master)
[![Total Downloads](https://poser.pugx.org/joskolenberg/laravel-jory/downloads)](https://packagist.org/packages/joskolenberg/laravel-jory)
[![Latest Stable Version](https://poser.pugx.org/joskolenberg/laravel-jory/v/stable)](https://packagist.org/packages/joskolenberg/laravel-jory)
[![License](https://poser.pugx.org/joskolenberg/laravel-jory/license)](https://packagist.org/packages/joskolenberg/laravel-jory)

# Laravel-Jory
Jory is a way of defining database queries using a JSON string, useful for loading dynamic data from the front-end. Jory can add high flexibility to your REST API and can easily be used alongside your existing code.

This package can be used for setting up Jory endpoints in Laravel, to learn about the conventions for setting up Jory queries, take a look at the [jory](https://packagist.org/packages/joskolenberg/jory) package.

## Installation
```
composer require joskolenberg/laravel-jory
```

## Usage
Every model you want to query using Jory needs it's own JoryBuilder.

### Creating a JoryBuilder
Call the ```make:jory-builder``` command to create a new JoryBuilder. Apply the ```--model``` option to get autogenerated configuration for a model class.
```
php artisan make:jory-builder BandJoryBuilder --model="App\Band"
```
Take a look [here](#configuring) to see how to configure the JoryBuilder.

### Register the JoryBuilder
JoryBuilders should be bound to the related model using the ```JoryBuilder::register()``` method. Register them in the boot method of a service provider:
```php
use Illuminate\Support\ServiceProvider;
use JosKolenberg\LaravelJory\JoryBuilder;

class JoryServiceProvider extends ServiceProvider
{
    public function boot()
    {
        JoryBuilder::register(\App\Band::class, \App\Http\JoryBuilders\BandJoryBuilder);
    }
}
```

### Apply Jory trait
Next, apply the JoryTrait to the model:

```php
use JosKolenberg\LaravelJory\Traits\JoryTrait;

class Band extends Model
{
    use JoryTrait;
}
```

### Create routes
Last, we need to create routes to expose our API to the world. Use the ```JoryBuilder::routes()``` method to do so.

routes.php:
```php
use JosKolenberg\LaravelJory\JoryBuilder;

JoryBuilder::routes('my-jory-api');
```

The JoryBuilder::routes() method will register the following routes for all registered JoryBuilders:
- ```GET``` ```/{resource}``` Get a [list of items](#resource-list) for this resource based on the Jory string in the 'jory' parameter.
- ```GET``` ```/{resource}/{id}``` Get a [single record](#single-resource) and apply the 'jory' parameter. 
- ```GET``` ```/{resource}/count``` Get the [record count](#resource-count) for the resource based on the 'jory' parameter.
- ```GET``` ```/``` Get [multiple](#multiple-resources) unrelated resources in one call.


#### Resource list
A ```GET``` call to ```/{resource}``` returns an array of items based on the ```jory``` parameter.

Example call:
```
GET /my-jory-api/band?jory={"flt":{"f":"name","o":"like","d":"%le%"},"fld":["year_start","name"],"srt":["-name"],"lmt":2,"rlt":{"albums":{"srt":["release_date"],"fld":["name","release_date"]}}}
```
Possible result:
```json
{
    "data": [
        {
            "name": "Led Zeppelin",
            "year_start": 1968,
            "albums": [
                {
                    "name": "Led Zeppelin",
                    "release_date": "1969-01-12"
                },
                {
                    "name": "Led Zeppelin II",
                    "release_date": "1969-10-22"
                },
                {
                    "name": "Led Zeppelin III",
                    "release_date": "1970-10-05"
                }
            ]
        },
        {
            "name": "Beatles",
            "year_start": 1960,
            "albums": [
                {
                    "name": "Sgt. Peppers lonely hearts club band",
                    "release_date": "1967-06-01"
                },
                {
                    "name": "Abbey road",
                    "release_date": "1969-09-26"
                },
                {
                    "name": "Let it be",
                    "release_date": "1970-05-08"
                }
            ]
        }
    ]
}
```

#### Single resource
A ```GET``` call to ```/{resource}/{id}``` returns a single item based on the ```id``` with the ```jory``` parameter applied.

Example call fetching a band's name including related album names and release dates:
```
GET /my-jory-api/band/1?jory={"fld":["name"],"rlt":{"albums":{"fld":["name","release_date"]}}}
```
Possible result:
```json
{
    "data": {
        "name": "Rolling Stones",
        "albums": [
            {
                "name": "Let it bleed",
                "release_date": "1969-12-05"
            },
            {
                "name": "Sticky Fingers",
                "release_date": "1971-04-23"
            },
            {
                "name": "Exile on main st.",
                "release_date": "1972-05-12"
            }
        ]
    }
}
```

#### Resource count
A ```GET``` call to ```/{resource}/count``` returns the number of records based on the filtering within the ```jory``` parameter.

Example call counting the bands with a name containing 'le':
```
GET /my-jory-api/band/count?jory={"flt":{"f":"name","o":"like","d":"%le%"}}
```
Possible result:
```json
{
    "data": 2
}
```

#### Multiple resources
A ```GET``` call to ```/``` allows you to fetch multiple resources in a single call.
This endpoint accepts a json object with key value pairs, the key being the resource name and the value being the Jory string.
Possible key values:
- ```'{resource}'``` get a list for this resource.
- ```'{resource}:{id}``` get a resource by id.
- ```'{resource}:count``` get a resource count.
- All keys can be post-fixed with ``` as {alias}``` to return the result on a different key, which allows to fetch a single resource multiple times.

For example, the following keys would all be valid: ```band```, ```band:2```, ```band:count```, ```band:2 as beatles```, ```band:count as number_of_bands```

Example call fetching:
- All bands having a name containing 'le'. ```band```: ```{"flt":{"f":"name","o":"like","d":"%le%"}}```
- All bands without a year_end returned as active_bands. ```band_as_active_bands```: ```{"flt":{"f":"year_end","o":"is_null"}}```
```
GET /my-jory-api?jory={"band":{"flt":{"f":"name","o":"like","d":"%le%"}},"band as active_bands":{"flt":{"f":"year_end","o":"is_null"}}}
```
Possible result:
```json
{
    "data": {
        "band": [
            {
                "id": 2,
                "name": "Led Zeppelin",
                "year_start": 1968,
                "year_end": 1980
            },
            {
                "id": 3,
                "name": "Beatles",
                "year_start": 1960,
                "year_end": 1970
            }
        ],
        "active_bands": [
            {
                "id": 1,
                "name": "Rolling Stones",
                "year_start": 1962,
                "year_end": null
            }
        ],
    }
}
```

## Configuring
To configure your JoryBuilder implement the ```config``` method, this method receives a ```Config``` object on which all configuration should be applied.
- All fields, filters, sorts and relations you want to expose need to be configured explicitly.
- All multiword configuration should be done using snake_case.

```php
class BandJoryBuilder extends JoryBuilder
{
    protected function config(Config $config): void
    {
        // Apply config
    }
}
```

### Registering filters
A filter option can be registered using the ```filter()``` method. Optionally a description and available operators can be provided:
```php
$config->filter('name')
    ->description('Filter by the band\'s name.')
    ->operators(['like', '=']);
```

### Registering sorts
A sort option can be registered using the ```sort()``` method. Optionally a description can be provided.

Apply the ```default()``` method on the sort to apply sorting on this field by default.
```php
$config->sort('id');

$config->sort('name')
    ->description('Sort by the band\'s name.')
    ->default();
```


### Registering fields
A field can be registered using the ```field()``` method. Optionally a description can be provided.

Apply the ```hideByDefault()``` method to NOT return this field when no explicit fields are requested.

Because all fields will mostly be used for filtering and sorting as well, convenient ```filterable()``` and ```sortable()``` methods are provided to register this in one go. You can use an optional callback to fill out any filter and sort details. 
```php
$config->field('id')->description('The band\'s id.')->filterable()->sortable()->hideByDefault();

$config->field('name')
    ->description('The band\'s name.')
    ->filterable(function (Filter $filter) {
        $filter->description('Filter by the band\'s name.')
            ->operators(['like', '=']);
    })->sortable(function (Sort $sort) {
        $sort->description('Sort by the band\'s name.')
            ->default();
    });
```

### Registering relations
A relation can be registered using the ```relation()``` method. Optionally a description can be provided.

```php
$config->relation('albums')->description('The band\'s albums');
```

### Setting pagination defaults
Use the ```limitDefault()``` method to set the default limit when no limit is given.
Use the ```limitMax()``` to set the maximum number of records that can be requested at once for this resource.

```php
$config->limitDefault(25)->limitMax(100);
```

### Defining custom filters
Often you want to be able to filter on more than just a field. You can add custom filter methods to the JoryBuilder using the following convention ```scope{CustomName}Filter()```:
```php
protected function scopeHasSongWithTitleFilter($query, $operator, $data)
{
    $query->whereHas('songs', function ($query) use ($operator, $data) {
        $query->where('title', $operator, $data);
    });
}
```
And don't forget to register the field in the configuration:
```php
$config->filter('has_song_with_title');
```

Alternatively you can make use of Laravel's built in model scopes. When the custom filter function is available on the model the JoryBuilder will find it as well.

### Defining custom sorts
Applying custom sorts is the same as custom filters except for the naming convention being ```scope{CustomName}Sort()```.

### Defining custom fields
To make custom fields available for your Jory api add them as a custom attribute on the model and make sure to add the field in the JoryBuilder's config.

### Hooks
Sometimes you may want to hook into the process to do some additional tweaking.

The JoryBuilder has these methods which can be overridden to do so:
- ```afterQueryBuild()``` Modify the query after all settings from the Jory input are applied but before it is executed.
- ```afterFetch()``` Modify the models right after they are fetched from the database.

The ```afterFetch()``` hook is useful to modify the models before the data is retrieved from them. For example, if an Invoice model has a calculated 'total_price' custom attribute which loops through all attached InvoiceLines you might want to eager load the InvoiceLines on the Invoices to save on querying. (This method always receives a collection even if only one item is requested.)
```php
protected function afterFetch(Collection $collection): Collection
{
    if ($this->hasField('total_price')) {
        $collection->load('invoiceLines');
    }
    
    return $collection;
}
``` 

## Config
To override Jory's default settings publish the config file using:
```
php artisan vendor:publish --provider="JosKolenberg\LaravelJory\JoryServiceProvider"
```

That's it! Any suggestions or issues? Please contact me!

Happy coding!

Jos Kolenberg <jos@kolenberg.net>